# 综合修复计划：本地运行 500 错误与脚本优化

针对您反馈的 500 错误持续存在、OIDC 配置疑问以及脚本冗余问题，以下是详细的修复方案：

## 一、 问题分析与解决方案

### 1. 解决本地运行 500 错误 (核心修复)
**原因分析**:
尽管我们修复了 JSON 解析问题，但 `mysql-database.js` 中的 `updateRow` 方法存在严重的**数据丢失风险**。
-   **全量覆盖 Bug**: `updateRow` 目前直接使用 `UPDATE ... SET data = JSON.stringify(rowData)`。如果前端只发送修改的字段（如只改名字），该行数据的其他字段会被清空，导致后续读取时出错（500 错误）。
-   **事务失效**: `get db()` 返回了一个“伪造”的事务对象，导致批量操作（Batch Operations）在 MySQL 下实际上是**并发执行且无保护**的，极易引发数据竞争和报错。

**修复方案**:
-   **重写 `updateRow`**: 实现 "Read-Merge-Write" 逻辑。先从数据库读取现有数据，与新数据合并，再写入数据库，确保不丢失字段。
-   **修复 `createRow`**: 增加对 `id` 的检查，如果未提供则自动生成，防止 SQL 报错。
-   **优化 `mysql-database.js`**: 移除伪造的事务警告，改为尽可能安全的异步操作。

### 2. OIDC 配置说明
**您的疑问**: "为什么要我自己填OIDC...项目其他文件里本身就已经有..."
**回答**: 非常抱歉给您带来困扰。我之前创建了一个全新的空 `.env` 文件，覆盖了您可能期望的配置。
**行动**:
-   我将**不再**要求您手动填写。
-   我会修改 `server/.env`，使其直接引用您 `docker-compose.yml` 或 `deploy-from-images.sh` 中可能存在的环境变量逻辑，或者仅保留必要的本地开发默认值（如 `localhost` 数据库配置），OIDC 部分留空并添加注释说明 "从系统环境变量读取"。

### 3. 移除冗余脚本
**您的疑问**: "为什么原来已经有自动化脚本又新增一个..."
**回答**: 您是对的，`redeploy.sh` 与现有的 `deploy.sh` 功能高度重叠。
**行动**:
-   **删除** `redeploy.sh`。
-   **优化** 现有的 `deploy.sh`：确保它包含端口映射检查和必要的环境验证，使其成为唯一且强大的部署入口。

## 二、 执行步骤

1.  **代码修复**: 修改 `server/db/mysql-database.js`，重点修复 `updateRow` 的合并逻辑和 `createRow` 的 ID 处理。
2.  **清理文件**: 删除 `redeploy.sh`。
3.  **配置调整**: 还原/优化 `server/.env`，避免不必要的配置项干扰。
4.  **验证**: 重启服务并验证 500 错误是否消除。

请确认是否执行此计划？
