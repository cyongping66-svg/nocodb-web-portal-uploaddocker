# 變更記錄

## 2025-10-22 回滾操作徽章顯示優化

- 變更項目：回滾操作徽章顯示功能優化
- 變更原因：原徽章無法清晰區分「回滾」與普通操作，且來源與具體內容提示不夠直觀。
- 變更目的：提升可讀性與可追溯性，以「相對時間 · 視圖名稱 · 操作動作：細節」標準格式顯示。

- 主要調整：
  - 新增標籤規則：操作標籤支持「動作 | 細節」分隔，示例：`行順序調整 | 第2行順序調整到第6行`。
  - 行拖拽事件中，使用當前可視索引組裝細節內容：`第${oldIndex+1}行順序調整到第${newIndex+1}行`。
  - 徽章渲染重構：優先顯示相對時間，其次視圖名稱，最後顯示「操作動作：細節」，不再附加固定尾註。
  - 兼容回滾顯示：撤銷後仍按上述格式展示（動作部分會包含「撤銷：」前綴）。

- 受影響文件：
  - `src/App.tsx`

- 驗收建議：
  - 在表格視圖進行一次可回滾操作（如拖動行順序），檢查徽章顯示為「最近操作：表格視圖 · 行順序調整 · 相對時間」。
  - 點擊「回滾上次操作」，確認徽章更新為「最近操作：表格視圖 · 撤銷：行順序調整 · 相對時間」。
  - 在卡片視圖進行操作與回滾，確認來源顯示為「卡片視圖」。

- 兼容性與風險：
  - 不影響原有回滾堆疊邏輯；僅新增展示狀態，無資料變更風險。
  - 當不存在操作或堆疊為空時，徽章不顯示。

- 版本標記：
  - 屬於前端 UI 改進，無需後端版本變更。

## 2025-10-22 行拖拽本地持久化存儲

- 變更項目：表格行拖拽順序的本地持久化存儲
- 變更原因：行拖拽後的順序在刷新頁面後未保留，影響使用體驗與一致性。
- 變更目的：在瀏覽器端持久化保存每個表的行順序，保證刷新或重開頁面後的展示一致。

- 主要調整：
  - 新增本地持久化工具：以 `tableRowOrder:<tableId>` 作為鍵，將行 ID 順序持久化到 `localStorage`。
  - 在 `useTables` 中應用本地順序：
    - `loadTables` 讀取行數據後按本地順序重排。
    - `updateTable` 接收到行順序變更時保存至本地。
    - `createRow` / `deleteRow` / `batchUpdateRows` 在重新加載行數據後按本地順序重排並同步本地映射，保持映射健康。
  - 與現有拖拽邏輯對齊：`DataTable` 的拖拽完成後通過 `onUpdateTable` 更新行順序，觸發持久化。

- 受影響文件：
  - `src/hooks/use-tables.ts`
  - `src/components/DataTable.tsx`（依賴 `onUpdateTable` 觸發持久化）

- 驗收建議：
  - 在表格視圖拖拽調整多行順序，刷新頁面後檢查行順序是否保持不變。
  - 新增或刪除行後再次刷新，確認本地映射同步且順序仍正確。
  - 切換到卡片視圖檢查展示順序一致。

- 兼容性與風險：
  - 新增：行拖拽順序本地持久化至 `better-sqlite3`，不使用瀏覽器緩存，避免刷新後改動消失。
    - 後端：
      - 新增資料表 `row_orders(table_id, row_id, position)` 持久化行順序。
      - 調整行查詢為按持久化順序返回：`GET /api/tables/:tableId/rows` 依據 `row_orders.position` 排序，無序的行按 `created_at` 置後。
      - 新增 API：`GET /api/tables/:tableId/rows/order` 讀取順序；`PUT /api/tables/:tableId/rows/order` 保存順序。
    - 前端：
      - 移除 `localStorage` 行序列映射，全部改為調用後端 API。
      - 在 `use-tables.updateTable()` 於更新表結構後，保存當前 `rows` 的 `id` 順序至後端。
      - `loadTables / createRow / updateRow / deleteRow / batchUpdateRows` 均依賴後端已排序的返回結果。
    - 開發環境：請啟動後端服務（`server` 目錄 `npm run dev`，預設 `http://localhost:8000`），前端 `vite` 代理 `/api` 至 8000 端口。

## 2025-10-22 表格視圖操作詳細標籤與徽章接入

- 變更項目：統一表格視圖操作標籤格式為「動作 | 細節」，接入徽章渲染並顯示具體細節
- 變更原因：原標籤僅顯示動作名稱，缺少具體上下文信息，無法在徽章中快速判斷操作內容
- 變更目的：提升操作可視化與審計友好度，與頁頭徽章的「相對時間 · 視圖名稱 · 操作動作：細節」渲染規則完全對齊

- 標籤規則：統一使用「動作 | 細節」格式；若包含括號補充，徽章端將自動清理括號內容

- 表格視圖動作映射：
  - 欄位設定變更 | 欄位：<欄位名稱>，變更筆數：<N>
  - 欄位順序調整 | <欄位名稱>：<舊索引> → <新索引>
  - 行順序調整 | ID：<行ID>：<舊索引> → <新索引>
  - 新增欄位 | <欄位名稱>（<類型>）
  - 刪除欄位 | <欄位名稱>（索引：<原索引>）
  - 新增行 | ID：<行ID>
  - 刪除行 | ID：<行ID>（索引：<原索引>）
  - 單元格編輯 | 欄位：<欄位名稱>，行：<行ID>，<舊值> → <新值>
  - 批量刪除 | 筆數：<N>
  - 批量編輯 | 欄位：<欄位名稱>，筆數：<N>，值：<目標值>
  - 批量複製 | 筆數：<N>

- 受影響文件：
  - `src/components/DataTable.tsx`

- 驗收建議：
  - 逐一測試上述操作，觀察頁頭徽章是否顯示詳細內容（來源應為「表格視圖」）
  - 測試回滾按鈕，確認徽章顯示為「撤銷：<動作 | 細節>」，且來源與時間準確

- 兼容性與風險：
  - 僅改動標籤字串，不影響原業務流程；若值類型為複雜物件，徽章可能顯示為通用字串（可後續優化格式化）

- 版本標記：
  - 前端展示優化，無需後端變更

## 2025-10-22 新增歷史修改記錄與任意版本回溯

- 變更項目：新增「歷史修改記錄」功能，支持持久化存儲並回溯到任意歷史版本；在「回滾上次操作」按鈕右側新增入口。
- 變更目的：提升審計可追溯性與可恢復能力，支持跨多次操作的版本選擇性回復。

- 主要功能：
  - 本地持久化歷史：每次資料修改後保存當前子表快照（名稱、欄位、行及順序）到 `localStorage`，按表分組管理。
  - 任意版本回溯：從歷史列表選擇任一版本，系統將同步更新表結構、補齊缺失行、刪除多餘行、批量更新現有行，並對齊行順序。
  - 入口位置：在「回滾上次操作」按鈕右側新增「歷史記錄」下拉菜單，展示「標籤 + 相對時間 + 來源」，支持一鍵回溯與清空當前表歷史。

- 受影響文件：
  - `src/App.tsx`

- 使用說明：
  - 進行任何資料修改（如新增/刪除行、編輯單元格、批量操作等）後，系統自動生成快照。
  - 點擊頁頭「歷史記錄」下拉，選擇目標版本即可回溯；如需重置歷史，點選「清空當前表歷史」。

- 兼容性與風險：
  - 歷史存儲採用前端 `localStorage`，僅針對本機瀏覽器；如需多人協同歷史，後續可擴展至後端存儲。
  - 回溯操作將調用後端 API 進行同步（更新結構、增刪改行、重排順序）；在大量資料下可能帶來一定延時。

- 驗收建議：
  - 在表格或卡片視圖執行多次操作，打開「歷史記錄」查看版本列表；選擇任意版本回溯，確認資料與行順序與該版本一致。
  - 測試「清空當前表歷史」後，歷史列表應顯示為空。

- 版本標記：
  - 前端功能新增，後端沿用現有 API 以完成回溯時的資料同步。
