# 变更记录

## 20241118 15:00 - 多表关联查询功能实现

### 修改原因
用户需要在智能表格中实现多表关联查询功能，以便能够搜索并显示关联了多个表的信息。例如：搜索客户时，能够同时显示该客户的所有订单及其关联的产品信息。

### 实现内容

1. **状态管理**：
   - 在DataTable组件中添加了`enableMultiTableQuery`状态变量，用于控制多表关联查询模式的开关

2. **UI界面**：
   - 在筛选弹窗中添加了多表关联查询切换开关，包含图标和说明文字
   - 使用ArrowRightLeft图标表示关联操作
   - 添加了Checkbox组件用于切换功能

3. **核心逻辑**：
   - 实现了`getRelatedTableData`函数：通过targetTableId从allTables查找关联表数据
   - 实现了`findRelatedData`递归函数：查找深层次的关联数据
   - 实现了`searchInRelatedData`函数：在关联数据中进行搜索
   - 实现了`formatMultiTableData`函数：根据数据类型（订单/产品/默认）格式化显示关联数据，最多显示3个属性

4. **显示逻辑**：
   - 在单选模式下：当启用多表关联查询时，显示主关联数据及其嵌套的关联信息，使用缩进和边框样式区分层级
   - 在多选模式下：同样支持显示每个关联项的嵌套信息，使用相同的层级展示样式

5. **搜索功能增强**：
   - 修改了筛选逻辑，支持在多表关联模式下搜索关联表的数据
   - 实现了递归搜索机制，可以搜索到深层次的关联数据

### 修改文件
- src/components/DataTable.tsx

### 功能效果
- 用户可以通过切换开关启用多表关联查询模式
- 在启用模式下，搜索时会自动查找并匹配关联表中的数据
- 显示结果中会以层级缩进的方式展示主表数据及其关联的表数据
- 支持单选和多选两种关联类型的层级数据展示
- 关联数据会根据类型进行格式化显示，提高可读性

## 20241118 16:30 - 双向关联数据同步支持

### 修改原因
在已实现的多表关联功能中，当用户在一个表中修改关联数据时，另一张表能够显示更新，但反向操作不支持，导致数据同步不完整。用户需要无论在哪张表中进行操作，都能看到所有关联表的最新数据。

### 实现内容

1. **updateRow函数增强**：
   - 添加了关联表识别逻辑，自动查找所有与当前表相互关联的表格
   - 实现了并行数据加载机制，使用Promise.all提高性能
   - 同步更新所有相关表格的数据，确保一致性

2. **createRow函数增强**：
   - 实现了与updateRow相同的双向关联更新机制
   - 确保新增行后，所有关联表都能及时刷新显示

3. **deleteRow函数增强**：
   - 添加了双向同步支持，删除行后自动刷新所有关联表
   - 保证数据删除操作在所有相关表中同步体现

4. **关联表识别逻辑**：
   - 查找以当前表为目标表的关联（其他表关联到当前表）
   - 查找当前表关联到的其他表
   - 确保包含当前表本身

### 修改文件
- src/hooks/use-tables.ts

### 功能效果
- 无论在哪张表中进行新增、修改或删除操作，所有相关联的表格都会自动刷新
- 双向关联数据保持完全同步，确保数据一致性
- 用户操作体验更流畅，无需手动刷新页面查看最新数据
- 多表协作效率提升，关联数据变更即时可见