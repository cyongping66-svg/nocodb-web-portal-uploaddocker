# 变更记录

## 20240723 编译错误修复（UserInfo类型完善）

### 修改原因
修复系统中存在的类型错误，特别是UserInfo接口定义不完整导致的编译错误和类型断言问题。

### 修改内容

1. **完善UserInfo接口定义**：
   - 在types.ts中添加了完整的UserInfo接口定义，包含id、user_id、company_id、department_id等关键字段
   - 确保user_id、company_id、department_id、group_id、position_id等ID字段存在
   - 添加role、permissions、foundation_user_role、foundation_user_permissions等权限相关字段
   - 添加索引签名以支持其他可能的字段

2. **修复App.tsx中的类型错误**：
   - 导入UserInfo类型并正确使用
   - 为用户信息对象添加类型断言
   - 优化空值处理，确保安全访问属性
   - 添加对role和permissions字段的支持，作为foundation_user_role和foundation_user_permissions的备选

3. **优化UserInfoCard组件**：
   - 在UserInfoCardProps接口中添加loading属性
   - 移除对@mui/material的依赖，使用原生HTML和内联样式重构组件
   - 添加loading状态处理逻辑

### 功能效果
- 解决了编译错误，使系统能够正常构建
- 提高了类型安全性，避免运行时潜在错误
- 增强了代码健壮性，改进了空值处理逻辑
- 减少项目依赖，保持原有功能的完整性

## 20240716 10:00 移除foundation登录相关代码

### 修改原因
- 移除系统中不再使用的foundation登录相关代码，简化用户认证流程
- 统一使用标准的role和permissions字段进行用户角色和权限管理
- 清理localStorage中不必要的foundation前缀字段，减少存储占用

### 修改内容
1. **App.tsx文件修改**
   - 移除OIDC回调处理中对foundation字段的localStorage存储操作
   - 移除HRSaaS用户信息处理中对foundation字段的引用
   - 修改loadCachedUserInfo和updateUserInfo函数，使用role和permissions字段替代foundation_user_role和foundation_user_permissions
   - 移除handleAdminLogin函数中对foundation字段的localStorage存储操作

2. **auth.ts文件检查**
   - 确认auth.ts中已不包含任何foundation相关代码
   - 验证用户信息处理逻辑完全基于标准字段，不再依赖foundation前缀字段

3. **文档更新**
   - 检查并更新相关文档，移除foundation登录相关描述

### 涉及文件
- src/App.tsx
- src/lib/auth.ts
- PRD-zh.md

### 修改效果
- 简化了用户认证和权限管理流程
- 移除了冗余的foundation前缀字段，统一使用标准字段
- 减少了localStorage中的存储内容
- 代码结构更加清晰，便于维护
- 不影响现有功能的正常使用，只是移除了不必要的兼容代码

## 20240715 10:00 修复账号详情页面数据显示问题

### 修改原因
- 解决打开账号详情页面时显示"未提供"，需要手动刷新才能显示正确信息的问题
- 根本原因是api.ts中的getUserInfo方法尝试调用不存在的/auth/userinfo端点，而不是使用auth.ts中已有的getUserInfo函数

### 修改内容
1. **优化api.ts中的用户信息获取逻辑**
   - 修改getUserInfo方法，改为使用auth.ts中已有的getUserInfo函数作为主要数据源
   - 确保返回统一的响应格式 { message: string, data: UserInfo }
   - 添加/auth/me端点作为备选数据源
   - 增强错误处理，在异常情况下返回结构化的错误信息
   - 修复数据结构不匹配问题，为返回的用户信息添加所有必要的ID字段（company_id, department_id, group_id, position_id, user_id, supervisor_id）
   - 确保在任何情况下都返回完整的数据结构，避免显示"未提供"信息

2. **改进UserProfilePage组件的数据获取机制**
   - 增强fetchUserInfo函数的错误处理能力，能够处理各种异常情况
   - 添加直接从auth模块获取用户信息的后备机制
   - 优化响应结构验证，确保能正确处理不同格式的返回数据
   - 添加页面可见性变化监听，当页面从隐藏变为可见时自动刷新用户信息

### 涉及文件
- src/lib/api.ts - getUserInfo方法
- src/components/UserProfilePage.tsx - fetchUserInfo函数和useEffect钩子

### 修改效果
- 账号详情页面首次加载时即可显示正确的用户信息，无需手动刷新
- 即使在网络波动或权限问题情况下，也能通过后备机制尝试获取用户信息
- 页面从后台切换到前台时自动刷新用户信息，确保数据最新
- 错误处理更加健壮，提供更好的用户体验
- 优化了数据获取流程，避免不必要的API调用

## 20240714 17:00 修复TypeScript类型错误

### 修改原因
- 修复auth.ts文件中fetchUserInfoFromHRSaaS函数的TypeScript类型错误
- 解决signal属性不存在和redirect属性类型不兼容的问题

### 修改内容
- 调整requestOptions对象定义，添加明确的RequestInit类型注解
- 将redirect属性的值明确转换为RequestRedirect类型
- 将signal属性直接包含在requestOptions对象中，避免后续添加导致的类型错误

### 涉及文件
- src/lib/auth.ts

### 效果
- 修复了TypeScript编译器错误
- 确保代码类型安全性
- 提高代码可维护性

## 20240714 16:00 优化HRSaaS API调用格式

### 修改原因
根据用户提供的API请求示例，需要严格按照指定的格式实现fetchUserInfoFromHRSaaS函数，确保能够成功获取用户信息。

### 修改内容
1. **调整请求头设置**
   - 移除了多余的Content-Type请求头
   - 保持language、tenant-id、platform、Accept和Authorization头的正确设置

2. **优化请求选项格式**
   - 严格按照API示例创建requestOptions对象
   - 添加redirect: 'follow'参数
   - 将超时控制与请求选项合并

3. **改进响应处理**
   - 先获取响应文本，再尝试解析JSON
   - 添加详细的响应日志记录
   - 优化JSON解析错误处理

### 修改效果
- 严格遵循API示例格式，提高API调用成功率
- 增强了日志记录，便于调试和问题排查
- 改进了错误处理，避免因响应格式问题导致程序崩溃

### 修改文件
- src/lib/auth.ts - fetchUserInfoFromHRSaaS函数

## 20240713 20:00 - fetchUserInfoFromHRSaaS函数请求头格式修改

### 修改原因
当前获取token后获取用户信息的方式不正确，需要按照指定的headers格式调用HRSaaS API。

### 修改内容
1. 更新auth.ts文件中的fetchUserInfoFromHRSaaS函数：
   - 将普通对象headers替换为Headers API
   - 添加language: "hk"请求头
   - 添加tenant-id: ""请求头
   - 添加platform: "api"请求头
   - 添加Accept: "application/json"请求头
   - 更新fetch请求使用新的myHeaders变量

2. 更新PRD-zh.md文件中的API接口文档：
   - 更新请求URL为完整路径
   - 更新请求头信息
   - 添加实现说明

### 修改效果
确保系统能够正确调用HRSaaS API获取用户信息，使用指定的请求头格式进行交互。

### 修改位置
- src/lib/auth.ts - fetchUserInfoFromHRSaaS函数
- PRD-zh.md - API接口文档部分

### 备注
完全按照用户提供的格式实现，确保请求头设置正确。

## 20240713 20:30 - 修复Authorization头缺失问题

### 修改原因
虽然token在调用fetchUserInfoFromHRSaaS前已正确获取，但函数实现中使用Headers API时没有添加Authorization头，导致API请求没有包含认证信息，无法成功获取用户信息。

### 修改内容
1. 更新auth.ts文件中的fetchUserInfoFromHRSaaS函数：
   - 移除未使用的headers常量定义
   - 在myHeaders中添加Authorization: `Bearer ${token}`请求头
   - 添加Content-Type: application/json请求头
   - 优化代码缩进格式

### 修改效果
确保API请求中包含必要的认证信息，使得fetchUserInfoFromHRSaaS函数能够成功调用HRSaaS API获取用户信息。

### 修改位置
- src/lib/auth.ts - fetchUserInfoFromHRSaaS函数

### 备注
此修复确保了token被正确用于API认证，解决了认证失败的问题。

## 20240713 19:30 - 系统错误分析与解决方案

### 修改原因
分析并记录系统运行中出现的多个错误，为后续修复提供依据。

### 修改内容
1. 分析auth.ts中的JWT token格式错误（Invalid JWT token format: incorrect number of parts）
2. 分析App.tsx中的用户信息重建失败问题
3. 调查spark.ts相关的401未授权错误
4. 提出相应的解决方案

### 效果
- 明确了三个错误之间的关联性
- 为开发团队提供了清晰的问题定位和解决思路

### 位置
- src/lib/auth.ts - JWT解析逻辑
- src/App.tsx - 用户信息重建逻辑
- 相关的spark配置文件

### 备注
主要问题根源：JWT token格式不符合标准的三段式结构，导致后续用户信息重建失败和认证异常，进而引发spark组件的401错误。建议进行JWT解析函数的健壮性优化和token生成流程的检查。

## 20240713 17:30 - 添加获取用户员工信息接口文档

### 修改原因
根据用户提供的接口定义，在PRD文档中添加完整的获取用户员工信息接口文档，确保开发团队能够正确理解和实现该接口。

### 修改内容
在PRD-zh.md文件中添加了获取用户员工信息接口的完整文档，包括：
1. 接口描述和基本信息
2. 请求方法、URL和请求头参数
3. 详细的响应数据结构和字段说明
4. 成功响应和错误响应示例
5. 接口使用场景说明

### 效果
完整记录了获取用户员工信息接口的所有技术细节，为前端开发人员提供了清晰的接口参考，确保接口的正确实现和使用。

## 20240713 16:30 - 移除email相关功能并优化token过期处理

### 修改原因
移除不必要的email功能依赖，修复token过期时出现的ReferenceError错误，确保应用在token过期时仍能正常运行。

### 修改内容
1. 从App.tsx中移除所有setCurrentEmail调用和email相关代码
2. 移除App.tsx中所有foundation_user_email的存储和读取操作
3. 从auth.ts的storageService中移除foundation_user_email相关的清理和存储操作
4. 优化认证错误处理流程，确保不依赖email相关功能

### 效果
修复了token过期时出现的"setCurrentEmail is not defined"错误，移除了不必要的email功能依赖，确保应用在token过期时仍能正常运行，并且构建成功。

## 20240713 14:30 - 修复多个关键TypeScript错误确保应用正常运行

### 修改原因
修复编译错误和运行时错误，确保应用可以正常启动和运行。

### 修改内容
1. 在auth.ts中添加storageService的导出语句，解决未导出问题
2. 在App.tsx中添加TokenData接口定义，修复类型错误
3. 为storageService使用添加安全检查，避免undefined错误
4. 修复DataTable.tsx中getRelatedTableDataByRow函数调用缺少参数的问题
5. 在auth.test.ts中添加Jest类型声明，解决类型错误

### 效果
解决了所有编译错误，确保应用可以正常启动和运行，修复了storageService使用和函数参数不匹配的问题。

## 20240221 14:30 - 优化token处理逻辑修复"没有找到token"错误

### 修改原因
优化应用在token不存在情况下的错误处理逻辑，避免直接中断应用流程，提高应用的健壮性。

### 修改内容
1. 在App.tsx第440-448行，将token不存在时的错误日志改为警告日志
2. 移除了token不存在时直接返回的逻辑，允许应用继续使用本地存储的用户信息
3. 在auth.ts的fetchUserInfoFromHRSaaS函数中添加了token参数的空值检查

### 效果
修复了"没有找到token"错误导致的应用中断问题，即使在没有token的情况下，应用也能在有限功能模式下继续运行，提高了用户体验和系统稳定性。

## 20240115 16:45 - 修复formatPassiveRelationData函数调用参数问题

### 修改原因
修复DataTable.tsx中formatPassiveRelationData函数调用缺少第二个参数的问题，确保关联信息能够正常显示。

### 修改内容
1. 在第3212行的formatPassiveRelationData函数调用中添加第二个参数空对象`{}`
2. 在第3262行的formatPassiveRelationData函数调用中添加第二个参数空对象`{}`

### 效果
修复了函数调用参数不匹配的问题，确保被动关联数据能够正确显示，同时保持了代码的兼容性。

## 20240115 16:30 - 修复DataTable.tsx编译错误

### 修改原因
修复DataTable.tsx文件中的语法错误和变量未定义问题，确保项目能够正常编译和运行。

### 修改内容
1. 修复了第3157-3158行多余的大括号导致的语法错误
2. 解决了val和displayText变量未定义的问题，改用formatMultiTableData函数
3. 确认所有formatPassiveRelationData函数调用都已正确传递表信息参数

### 效果
项目可以成功编译并在开发服务器上运行，不再出现语法错误和变量未定义的编译失败。

## 20240115 15:30 - 修复被动关联数据显示功能

### 修改原因
修复多表关联查询中被动关联数据显示的问题，确保正确调用formatPassiveRelationData函数并传递表信息参数。

### 修改内容
1. 在单选模式下的被动关联数据显示逻辑中，更新了formatPassiveRelationData函数调用，添加了表信息参数传递。
2. 在传统方式处理关联数据部分，修复了formatPassiveRelationData函数调用，确保传递表信息参数。
3. 在多选模式下的被动关联数据显示逻辑中，调整了数据结构处理，按照表分组显示被动关联数据。
4. 优化了被动关联数据的显示格式，增加了表格名称显示和数据量限制（最多显示3条，超出部分提示）。

### 效果
修复后，当用户勾选多表关联查询时，可以正确显示被动关联数据（即引用当前记录的数据），并按照关联表分组展示，提升了数据关联性的可视化体验。



## 20241118 15:00 - 多表关联查询功能实现

### 修改原因
用户需要在智能表格中实现多表关联查询功能，以便能够搜索并显示关联了多个表的信息。例如：搜索客户时，能够同时显示该客户的所有订单及其关联的产品信息。

### 实现内容

1. **状态管理**：
   - 在DataTable组件中添加了`enableMultiTableQuery`状态变量，用于控制多表关联查询模式的开关

2. **UI界面**：
   - 在筛选弹窗中添加了多表关联查询切换开关，包含图标和说明文字
   - 使用ArrowRightLeft图标表示关联操作
   - 添加了Checkbox组件用于切换功能

3. **核心逻辑**：
   - 实现了`getRelatedTableData`函数：通过targetTableId从allTables查找关联表数据
   - 实现了`findRelatedData`递归函数：查找深层次的关联数据
   - 实现了`searchInRelatedData`函数：在关联数据中进行搜索
   - 实现了`formatMultiTableData`函数：根据数据类型（订单/产品/默认）格式化显示关联数据，最多显示3个属性

4. **显示逻辑**：
   - 在单选模式下：当启用多表关联查询时，显示主关联数据及其嵌套的关联信息，使用缩进和边框样式区分层级
   - 在多选模式下：同样支持显示每个关联项的嵌套信息，使用相同的层级展示样式

5. **搜索功能增强**：
   - 修改了筛选逻辑，支持在多表关联模式下搜索关联表的数据
   - 实现了递归搜索机制，可以搜索到深层次的关联数据

### 修改文件
- src/components/DataTable.tsx

### 功能效果
- 用户可以通过切换开关启用多表关联查询模式
- 在启用模式下，搜索时会自动查找并匹配关联表中的数据
- 显示结果中会以层级缩进的方式展示主表数据及其关联的表数据
- 支持单选和多选两种关联类型的层级数据展示
- 关联数据会根据类型进行格式化显示，提高可读性

## 20241118 16:30 - 双向关联数据同步支持

### 修改原因
在已实现的多表关联功能中，当用户在一个表中修改关联数据时，另一张表能够显示更新，但反向操作不支持，导致数据同步不完整。用户需要无论在哪张表中进行操作，都能看到所有关联表的最新数据。

### 实现内容

1. **updateRow函数增强**：
   - 添加了关联表识别逻辑，自动查找所有与当前表相互关联的表格

## 20241120 14:00 - 多表关联查询点击功能修复

### 修改原因
用户报告在使用多表关联查询功能时，点击关联信息无法查看详情的问题。原功能只能显示关联数据的摘要，缺少点击交互和详细信息展示能力。

### 实现内容

1. **状态管理**：
   - 添加了`showRelationDetail`、`selectedRelationData`和`relationDataTitle`状态变量，用于控制关联详情弹窗的显示和内容

2. **事件处理**：
   - 实现了`handleRelationClick`函数，用于处理关联数据点击事件，设置选中数据并打开弹窗
   - 实现了`renderRelationDetail`递归函数，用于格式化渲染复杂的嵌套关联数据

3. **UI交互增强**：
   - 为所有关联数据显示元素添加了点击事件处理
   - 添加了鼠标悬停样式（cursor-pointer、hover效果），提高用户交互体验
   - 支持在多选和单选模式下的所有关联数据元素的点击交互

4. **详情展示组件**：
   - 添加了关联数据详情弹窗组件，使用Dialog组件实现
   - 弹窗支持显示复杂的嵌套关联数据，使用缩进样式展示层级关系
   - 弹窗包含标题、描述和关闭按钮，提供完整的用户体验

5. **组件导入修复**：
   - 在导入语句中添加了缺失的`DialogDescription`和`DialogFooter`组件，确保代码能够正常编译和运行

### 修改文件
- src/components/DataTable.tsx

### 功能效果
- 用户现在可以点击任何关联数据元素查看完整的详细信息
- 点击后会弹出一个模态窗口，以层级缩进的形式展示所有关联数据属性
- 弹窗可以显示嵌套的多层级关联数据，提供完整的数据视图
- 所有可点击元素都有明显的视觉反馈，提高了可用性
- 关联数据以易读的格式呈现，包括属性名和对应的值
   - 实现了并行数据加载机制，使用Promise.all提高性能
   - 同步更新所有相关表格的数据，确保一致性

2. **createRow函数增强**：
   - 实现了与updateRow相同的双向关联更新机制
   - 确保新增行后，所有关联表都能及时刷新显示

3. **deleteRow函数增强**：
   - 添加了双向同步支持，删除行后自动刷新所有关联表
   - 保证数据删除操作在所有相关表中同步体现

4. **关联表识别逻辑**：
   - 查找以当前表为目标表的关联（其他表关联到当前表）
   - 查找当前表关联到的其他表
   - 确保包含当前表本身

### 修改文件
- src/hooks/use-tables.ts

### 功能效果
- 无论在哪张表中进行新增、修改或删除操作，所有相关联的表格都会自动刷新
- 双向关联数据保持完全同步，确保数据一致性
- 用户操作体验更流畅，无需手动刷新页面查看最新数据
- 多表协作效率提升，关联数据变更即时可见