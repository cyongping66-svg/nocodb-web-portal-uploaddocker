# 数据库界面构建器 - 产品需求文档（同步当前实现）

## 概述
- 一个现代化的Web应用，允许用户创建和管理自定义的类数据库界面，以多种视图组织和可视化数据（网格视图、卡片视图）。
- 目标体验：专业、直观、高效，聚焦数据管理的可靠性与操作效率。
- 复杂度级别：轻量级应用，提供核心能力并保持前后端性能与简单性。

## 最新功能与变更总览
- 行拖拽与顺序持久化：支持在无筛选/排序/搜索时对行进行任意拖拽排序，并通过后端持久化保存顺序。
- 版本历史与回溯：后端存储表的快照历史；支持创建快照、查看列表、清空历史、回溯到指定版本，含回溯确认对话框。
- 撤销能力：提供“回滚上次操作”按钮与全局撤销栈，支持连续回滚；每次操作自动记录快照用于审计。
- 导出：支持将当前表数据以`xlsx`格式导出；支持选择多行后仅导出所选数据。
- 文件附件：列类型新增`file`，支持上传、预览（图片/视频/音频/PDF/其他）、清空列内附件信息（保留磁盘文件以支持撤回）。
- 响应式与移动体验：移动端默认使用卡片视图，支持汉堡菜单与遮罩；桌面端为数据密集型网格视图。
- 提示优化：移除切换表格时的全局提示，仅保留针对具体操作的成功反馈。
- 导航入口与版本信息：左侧导航底部新增“反馈建议入口”外链；显示版本信息（当前为`v1.1`），以蓝色圆点+文本样式呈现。
- 列配置与多选：选择类型列支持单选/多选；支持在配置中管理选项并通过批量更新同步变更。
- 列宽调整与列拖拽：支持列宽拖拽调整（最小宽度120px、默认200px）与列顺序拖拽。
- 选择与批量操作：支持行选择/全选、批量删除/批量更新，以及导出选中。
- 健康检查与静态文件：后端提供`/api/health`；上传文件通过`/api/uploads/...`提供静态访问。

## 核心功能

### 导航栏功能扩展
- 功能：左侧导航栏最下方添加“反馈建议入口”外链，点击在新标签页打开指定页面（`https://omeoffice.com/usageFeedback`）。
- 显示：在导航顶部显示存储状态（绿色小圆点 + “本地存儲 (SQLite)”）；其下方显示版本信息行：蓝色小圆点 + 文本“版本信息: v1.1”。
- 成功标准：链接可正常跳转；版本信息清晰可见，与实现一致（蓝色圆点 + 文本，而非纯蓝色粗体）。

### 表格管理
- 功能：创建、重命名、删除子表；定义初始列；支持后续列管理。
- 触发：点击“新增子表”或在表格管理中执行操作。
- 流程：新建 → 输入名称 → 定义列 → 保存 → 显示在侧栏；重命名与删除均记录历史快照。
- 成功标准：表格可持久化并可选择/修改；相关操作可在历史中追踪。

### 列配置
- 功能：添加/删除列；列类型包括`text`、`number`、`date`、`boolean`、`select`（支持单选/多选）、`file`、`url`、`email`、`phone`。
- 说明：
  - 日期类型支持时间信息；空值按类型安全处理（如`number`→0、`boolean`→false）。
  - 选择类型支持“启用多选模式”；选项编辑支持新增/删除；保存时可通过批量更新同步各行值。
- 列拖拽与宽度：
  - 列顺序可拖拽调整，并记录快照与支持回滚；
  - 列宽可拖拽调整，最小宽度120px，默认200px。

### 数据输入与编辑
- 功能：添加、编辑、删除行；支持内联编辑与表单验证；行选择与全选（支持导出/批量操作）。
- 文件附件：在`file`列中上传附件；支持图片/视频/音频/PDF等预览；清空列内文件信息不会删除磁盘文件（用于撤回场景）。
- 成功标准：数据类型验证正确；附件可上传/预览/清空；批量操作与选择工作正常。

### 视图模式
- 功能：在网格视图和卡片视图之间切换（桌面默认网格，移动默认卡片）。

### 高级选项关联字段功能优化
- 功能：
  1. 允许同时勾选关联字段功能和字典子表功能，实现更灵活的数据关系配置。
  2. 剔除勾选关联字段功能后出现的关联类型选择，简化用户界面并优化操作流程。
- 目的：提高数据关系配置的灵活性，简化用户操作体验。
- 实现细节：
  - 修改关联字段复选框与字典子表复选框的互斥关系，改为可同时勾选。
  - 移除关联字段功能下的关联类型选择界面元素，默认使用合适的关联方式。
  - 确保两种功能同时启用时的数据一致性和稳定性。
- 成功标准：
  - 可同时勾选并配置关联字段和字典子表功能。
  - 勾选关联字段功能后不再显示关联类型选择界面。
  - 两种功能同时启用时系统运行稳定，无错误提示。
- 成功标准：两种视图均可正常访问和编辑数据；移动端布局简洁，触控友好。

### 行拖拽与顺序持久化
- 功能：在无排序/筛选/搜索条件时，支持通过拖拽调整行顺序；顺序在后端持久化。
- 触发：在表格视图中按住行拖动手柄进行上下拖拽。
- 限制：当开启排序、筛选或搜索时不支持行拖拽（界面提示错误）。
- 流程：拖拽完成 → 前端更新`rows`顺序 → 触发表更新 → 后端通过`row_orders`持久化顺序。
- 成功标准：刷新后顺序保持；新建行在未设置顺序时追加末尾；支持撤回到拖拽前状态。

### 导出
- 功能：将表格数据导出为`xlsx`格式；支持导出选中的行。
- 成功标准：导出文件可在Excel中正常打开与编辑；导出仅包含选中数据（在批量导出场景）。

### 撤销与历史
- 撤销栈：提供“回滚上次操作”按钮，支持连续回滚；每次回滚也会记录快照。
- 历史记录：
  - 下拉菜单显示历史列表（时间使用本地格式化，支持相对时间徽章展示）；
  - 选择历史项弹出确认对话框，确认后回溯到该版本；
  - 支持“保存当前版本并清除历史记录”。
- 成功标准：操作后快照可查询；回溯后刷新数据并提示成功；审计链完整。

## 用户流程
- 新建子表：点击“新增子表”→ 输入名称 → 创建 → 自动记录“新增子表”快照。
- 编辑列：打开“欄位設定”对话 → 编辑名称/类型/选项/多选模式 → 保存 → 快照记录；必要时批量同步行值。
- 新增/编辑/删除行：在网格/卡片视图中对单元格内联编辑、添加或删除；支持行选择与批量操作。
- 行拖拽：当未开启排序/筛选/搜索时，用手柄上下拖拽调整顺序；完成后提示“行顺序已更新”。
- 文件上传与预览：在`file`列点击上传；支持预览与清空；清空仅取消列关联。
- 视图切换：工具栏切换到网格/卡片；移动端默认卡片视图。
- 撤销与历史：点击“回滚上次操作”或在“历史记录”中选择条目并确认回溯。

## 界面设计规范
- 颜色与字体：延续蓝色为主、灰为辅、橙色强调；使用 Inter 字体家族，层级清晰（H1/H2/H3/正文/标签）。
- 动画：适度淡入/过渡，强调数据操作的即时反馈，避免干扰。
- 组件：表格、卡片、对话框、按钮、输入、选择、选项卡、下拉菜单、复选框、图标（加号、下载、撤回、历史、垃圾桶等）。
- 桌面表格布局：
  - 表头：选择列（全选/取消全选）+ 可排序/可拖拽列 + 预留操作列；
  - 行：左侧手柄可拖拽；右侧操作按钮；空状态与筛选空结果提供引导与清除入口。
- 移动布局：卡片列表优先显示前三列，其余以“还有 N 个欄位”提示；顶部提供选择与删除。
- 导航栏（左侧）：标题“孵化之路信息管理系統”、存储状态、版本信息、子表管理、底部反馈入口；移动端提供汉堡按钮与遮罩。

## 技术要求
- 前端
  - DnD：采用`@dnd-kit`实现列/行拖拽；行拖拽受排序/筛选/搜索状态约束。
  - 导出：使用`xlsx`库生成`xlsx`文件。
  - 提示：采用`sonner`；仅保留具体操作成功反馈；切换表格不显示全局提示。
  - 视图与状态：网格/卡片视图切换；移动端自适配（屏宽<768默认卡片视图，隐藏侧栏）。
  - API封装：`/api`为基地址；统一`fetch`封装，错误抛出并记录日志。
- 后端
  - 数据库：SQLite；表结构包含`tables`、`rows`、`row_orders`、`table_history`等。
  - 行顺序：`row_orders(table_id, row_id, position)`；`getTableRows`通过`LEFT JOIN row_orders`并按`position ASC`与`created_at ASC`排序；未设置顺序的行排在末尾。
  - 行顺序API：
    - `GET /api/tables/:tableId/rows/order` → 返回`{ orderIds: string[] }`
    - `PUT /api/tables/:tableId/rows/order` → 请求`{ orderIds: string[] }`
  - 行数据API：`GET/POST/PUT/DELETE /api/tables/:tableId/rows`及批量接口`POST /api/tables/:tableId/rows/batch`（`operation=update|delete|create`）。
  - 文件上传：`POST /api/tables/:tableId/rows/:rowId/files/:columnId`；清空：`DELETE /api/tables/:tableId/rows/:rowId/files/:columnId`；静态访问路径`/api/uploads/...`。
  - 历史API：
    - 列表：`GET /api/tables/:tableId/history`
    - 详情：`GET /api/tables/:tableId/history/:historyId`
    - 新增：`POST /api/tables/:tableId/history`（若未提供`snapshot`，后端自动生成当前快照）
    - 清空：`DELETE /api/tables/:tableId/history`
    - 回溯：`POST /api/tables/:tableId/history/:historyId/revert`
  - 健康检查：`GET /api/health`
- 代理与本地运行
  - 前端开发服务器通过 Vite 代理`/api`到后端（`http://localhost:8000`）。

## 边缘情况处理
- 空表格：显示占位与引导；提供新增入口。
- 无效数据类型：清晰验证消息，防止无效输入。
- 大型数据集：表格支持虚拟滚动（按需优化）。
- 并发与冲突：通过乐观更新与冲突解决；必要时刷新以对齐后端状态。
- 存储与访问：当文件访问端口与前端不同，前端将相对路径转换为完整URL以确保可预览。

## 提示优化（当前状态）
- 目标：减少无关提示，只在实际操作（新增/编辑/删除/拖拽/上传/导出/回溯等）时给出明确反馈。
- 切换表格：不再显示“表格已更新/已加载上次保存数据”等全局提示。

## 成功标准（摘要）
- 行顺序：拖拽后持久化，刷新保持顺序；限制条件明确并有错误提示；支持撤回。
- 历史：每次重要操作自动保存快照；列表/回溯/清空流程可用，确认对话框信息完整。
- 导出：`xlsx`文件生成稳定，能在Excel正常打开；支持导出选中子集。
- 文件：上传与预览稳定；清空列内附件信息不删除磁盘文件；URL在不同端口下可正确访问。
- 响应式：桌面/移动布局与交互一致性良好；移动端默认卡片视图与汉堡菜单生效。
- 导航与版本：反馈入口跳转正常；版本信息以蓝色圆点+文本显示，便于识别与维护。