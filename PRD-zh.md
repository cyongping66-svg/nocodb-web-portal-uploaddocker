# 数据库界面构建器 - 产品需求文档（同步当前实现）

## 概述

## 最新修复需求

### 字段关联命名一致性要求
- **需求描述**: 在创建或维护关联时，需要确保被关联的两个字段名称一致才允许建立关联关系
- **修复目标**: 修改关联字段功能，在选择关联列时增加字段名称匹配验证，确保只有名称相同的字段才能建立关联
- **影响范围**: 关联字段功能，影响用户建立表之间的关联关系
- **实现细节**:
  - 在选择关联列时，仅显示与当前字段名称相同的目标列选项
  - 添加名称匹配验证逻辑，在用户尝试关联名称不匹配的字段时给出明确提示
  - 确保前端界面在选择目标表后，只展示名称相同的字段供用户选择
- **验收标准**: 
  - 系统仅允许相同名称的字段建立关联关系
  - 创建关联字段时，选择列表中只显示名称匹配的目标字段
  - 当尝试关联名称不匹配的字段时，系统给出明确错误提示

### JSX语法错误修复
- **问题描述**: DataTable.tsx文件第3639行的div标签缺少闭合标记，导致编译错误
- **修复目标**: 添加缺失的div闭合标签，确保JSX代码结构完整
- **影响范围**: 新增字段对话框功能
- **验收标准**: 项目能够成功构建，新增字段功能正常工作

### 属性类型错误修复
- **问题描述**: DataTable.tsx文件第597行使用了不存在的属性targetTableName，导致类型错误
- **修复目标**: 移除或替换不存在的targetTableName属性，确保类型定义正确
- **影响范围**: 关联字段配置功能，可能影响用户设置表格间的关联关系
- **验收标准**: 构建过程中不再出现属性类型错误，关联字段配置功能正常工作

### 参考文件清理
- **问题描述**: DataTable-fixed.tsx文件中存在大量编译错误，主要是缺少组件导入和变量定义
- **修复目标**: 由于DataTable.tsx已修复，DataTable-fixed.tsx作为参考文件可以考虑删除
- **影响范围**: 无直接功能影响，仅为代码清理
- **验收标准**: 删除不必要的参考文件，保持代码库整洁

### 关联字段功能修复
- **问题描述**: 目前无法正确实现通过一个字段关联两个表的功能，无论是创建还是设置字段都存在问题
- **修复目标**: 修复关联字段功能，确保用户能够成功创建和配置表之间的关联关系
- **影响范围**: 表间关联功能，影响用户建立数据之间的关系结构
- **验收标准**: 用户能够成功创建关联字段，正确关联两个表，并在数据视图中看到关联数据

### DataTable-fixed.tsx 相关编译错误处理
- **问题描述**: 诊断信息中提到 DataTable-fixed.tsx 文件存在编译错误，但该文件已不存在
- **修复目标**: 解决编译错误，确保项目构建正常
- **影响范围**: 项目构建过程
- **验收标准**: 项目能够成功构建，无编译错误
- **解决方案**: 创建一个空的 DataTable-fixed.tsx 文件，添加注释说明该文件已不再使用，仅保留以避免编译错误

## 被动关联数据显示功能修复

### 需求背景
用户反馈在勾选多表关联查询选项时，无法正常看到关联的信息。经过分析，发现被动关联数据（即引用当前记录的数据）显示逻辑存在问题，主要是formatPassiveRelationData函数调用时缺少必要的表信息参数传递。

### 需求分析

#### 核心问题
- formatPassiveRelationData函数需要表信息来正确格式化显示数据
- 被动关联数据需要按照关联表分组显示，提升可读性
- 需要限制每个表显示的数据数量，避免信息过载

#### 影响范围
- 单选模式下的关联数据显示
- 多选模式下的关联数据显示
- 传统方式处理关联数据的部分

### 功能逻辑描述

#### 数据结构分析
getRelatedTableDataByRow函数返回的数据结构为：
```javascript
[
  {
    table: { id: 'tableId', name: 'tableName' },
    rows: [row1, row2, ...]
  },
  ...
]
```

#### 被动关联数据显示逻辑
1. **数据获取**：通过getRelatedTableDataByRow(row.id)获取被动关联数据
2. **数据分组**：按照关联表进行分组显示
3. **表名显示**：每个分组显示对应的表名
4. **数据限制**：每个表最多显示3条数据，超出部分显示提示信息
5. **数据格式化**：调用formatPassiveRelationData(relatedItem, relatedTable.table)进行格式化，确保传递表信息
6. **样式区分**：使用border-secondary/30样式区分被动关联数据
7. **交互处理**：点击被动关联数据项时触发handleRelationClick事件

### 界面展示

#### 单选模式
- 主动关联数据：使用primary/30边框样式
- 被动关联数据：使用secondary/30边框样式，按照表分组显示，每组显示表名和最多3条数据

#### 多选模式
- 主动关联数据：使用primary/20边框样式
- 被动关联数据：使用secondary/30边框样式，按照表分组显示，每组显示表名和最多3条数据

#### 传统方式
- 主动关联数据：保持原有样式和显示逻辑
- 被动关联数据：按照表分组显示，每组显示表名和最多3条数据，使用secondary/30边框样式

### 技术实现要点
1. 修改DataTable.tsx中的三处被动关联数据显示逻辑
2. 正确处理getRelatedTableDataByRow返回的数据结构
3. 确保formatPassiveRelationData函数调用时传递正确的参数
4. 优化UI展示，提高用户体验

### 验收标准
- 被动关联数据能够正确显示并按照表分组
- 每个表分组显示对应的表名和最多3条数据
- 数据显示样式正确区分主动关联和被动关联
- 点击被动关联数据能够正常交互

- 一个现代化的Web应用，允许用户创建和管理自定义的类数据库界面，以多种视图组织和可视化数据（网格视图、卡片视图）。
- 目标体验：专业、直观、高效，聚焦数据管理的可靠性与操作效率。
- 复杂度级别：轻量级应用，提供核心能力并保持前后端性能与简单性。

## 最新功能与变更总览
- 行拖拽与顺序持久化：支持在无筛选/排序/搜索时对行进行任意拖拽排序，并通过后端持久化保存顺序。
- 版本历史与回溯：后端存储表的快照历史；支持创建快照、查看列表、清空历史、回溯到指定版本，含回溯确认对话框。
- 撤销能力：提供“回滚上次操作”按钮与全局撤销栈，支持连续回滚；每次操作自动记录快照用于审计。
- 导出：支持将当前表数据以`xlsx`格式导出；支持选择多行后仅导出所选数据。
- 文件附件：列类型新增`file`，支持上传、预览（图片/视频/音频/PDF/其他）、清空列内附件信息（保留磁盘文件以支持撤回）。
- 响应式与移动体验：移动端默认使用卡片视图，支持汉堡菜单与遮罩；桌面端为数据密集型网格视图。
- 提示优化：移除切换表格时的全局提示，仅保留针对具体操作的成功反馈。
- 导航入口与版本信息：左侧导航底部新增“反馈建议入口”外链；显示版本信息（当前为`v1.1`），以蓝色圆点+文本样式呈现。
- 列配置与多选：选择类型列支持单选/多选；支持在配置中管理选项并通过批量更新同步变更。
- 列宽调整与列拖拽：支持列宽拖拽调整（最小宽度120px、默认200px）与列顺序拖拽。
- 选择与批量操作：支持行选择/全选、批量删除/批量更新，以及导出选中。
- 健康检查与静态文件：后端提供`/api/health`；上传文件通过`/api/uploads/...`提供静态访问。

## 核心功能

### 导航栏功能扩展
- 功能：左侧导航栏最下方添加“反馈建议入口”外链，点击在新标签页打开指定页面（`https://omeoffice.com/usageFeedback`）。
- 显示：在导航顶部显示存储状态（绿色小圆点 + “本地存儲 (SQLite)”）；其下方显示版本信息行：蓝色小圆点 + 文本“版本信息: v1.1”。
- 成功标准：链接可正常跳转；版本信息清晰可见，与实现一致（蓝色圆点 + 文本，而非纯蓝色粗体）。

### 表格管理
- 功能：创建、重命名、删除子表；定义初始列；支持后续列管理。
- 触发：点击“新增子表”或在表格管理中执行操作。
- 流程：新建 → 输入名称 → 定义列 → 保存 → 显示在侧栏；重命名与删除均记录历史快照。
- 成功标准：表格可持久化并可选择/修改；相关操作可在历史中追踪。

### 列配置
- 功能：添加/删除列；列类型包括`text`、`number`、`date`、`boolean`、`select`（支持单选/多选）、`file`、`url`、`email`、`phone`。
- 说明：
  - 日期类型支持时间信息；空值按类型安全处理（如`number`→0、`boolean`→false）。
  - 选择类型支持“启用多选模式”；选项编辑支持新增/删除；保存时可通过批量更新同步各行值。
- 列拖拽与宽度：
  - 列顺序可拖拽调整，并记录快照与支持回滚；
  - 列宽可拖拽调整，最小宽度120px，默认200px。

### 数据输入与编辑
- 功能：添加、编辑、删除行；支持内联编辑与表单验证；行选择与全选（支持导出/批量操作）。
- 文件附件：在`file`列中上传附件；支持图片/视频/音频/PDF等预览；清空列内文件信息不会删除磁盘文件（用于撤回场景）。
- 成功标准：数据类型验证正确；附件可上传/预览/清空；批量操作与选择工作正常。

### 视图模式
- 功能：在网格视图和卡片视图之间切换（桌面默认网格，移动默认卡片）。

### 进阶筛选多表关联查询功能
- **需求描述**：在筛选弹窗中添加多表关联查询切换，允许用户搜索关联了两个或多个表的信息，实现跨表数据的关联查询。
- **功能目标**：
  1. 在筛选弹窗中添加一个切换开关，用于启用/禁用多表关联查询模式
  2. 启用后，用户搜索时自动关联查询所有相关联的表数据
  3. 支持至少三级关联查询（如：客户表 → 订单表 → 产品表）
  4. 结果展示时显示完整的关联数据层级关系
  5. 允许用户点击查看关联信息，展示关联表的详细数据
- **当前问题**：用户反馈点击关联信息后无法正常查看关联数据，点击操作无响应或显示错误。
- **使用场景示例**：
  - 用户搜索“客户 A”（客户表的姓名）
  - 系统自动带出客户 A 的所有订单（通过“客户 ID”关联订单表）
  - 每个订单又自动带出对应的产品名称、库存等信息（通过“产品 ID”关联产品表）
  - 最终呈现：客户 A → 订单 1（金额 500 元，产品：手机，库存 100 台）、订单 2（金额 300 元，产品：耳机，库存 50 台）
  - 用户可以点击订单 1 查看该订单的详细关联信息，包括客户信息和产品信息
- **实现细节**：
  - 修改筛选弹窗组件，添加多表关联查询的切换开关
  - 实现关联数据的递归查询逻辑，支持多级关联
  - 修复点击关联信息无响应的问题，确保点击操作能够正确触发关联信息展示
  - 实现关联详情展示组件，清晰呈现关联数据
  - 优化查询性能，避免不必要的重复查询
  - 设计清晰的结果展示界面，显示关联层级关系
- **验收标准**：
  - 筛选弹窗中成功添加多表关联查询切换开关
  - 启用开关后，搜索能正确关联查询所有相关表的数据
  - 点击关联信息能够正确显示关联的详细数据
  - 结果展示清晰，显示完整的关联数据层级
  - 查询性能良好，无明显延迟

### 高级选项关联字段功能优化
- 功能：
  1. 允许同时勾选关联字段功能和字典子表功能，实现更灵活的数据关系配置。
  2. 剔除勾选关联字段功能后出现的关联类型选择，简化用户界面并优化操作流程。
  3. 在表头显示关联表名称，提升用户交互体验。
  4. 实现完整的单步操作双向关联：用户只需在一个表中创建关联字段，系统自动在目标表中创建对应的反向关联字段，无需手动操作两次，并在被关联表的字段名上显示关联表格名称的小字。
  5. 优化关联字段交互体验：创建关联字段后，点击字段设置应正确显示已设置的关联关系。
  6. 字段类型匹配限制：只有相同类型的字段才能互相关联，系统应仅显示与当前字段类型相同的目标列选项。
  7. 字段名称匹配限制：关联两个表时，除了字段类型相同外，还要求两个字段名称相同，以确保数据关系的一致性和可维护性。
  8. 关联字段功能分區顯示：使用高亮區塊明確標示關聯字段功能範圍。
  9. 字典子表功能分區顯示：使用高亮區塊明確標示字典子表功能範圍。
- 目的：提高数据关系配置的灵活性和直观性，极大简化用户操作体验（只需操作一次即可完成双向关联），增强数据的双向关联性和可视化展示，确保关联字段的一致性和数据完整性。提升界面清晰度，使用户能清晰識別不同功能模塊。
- 实现细节：
  - 修改关联字段复选框与字典子表复选框的互斥关系，改为可同时勾选。
  - 移除关联字段功能下的关联类型选择界面元素，默认使用合适的关联方式。
  - 在表头中显示关联表的名称，使用户能够直观地了解字段的关联关系。
  - 在保存列配置的过程中，自动在目标表中创建对应的反向关联字段，用户无需手动操作目标表。
  - 在被关联表的字段名下方以小字形式显示关联表格的名称。
  - 确保两种功能同时启用时的数据一致性和稳定性。
  - 确保关联字段设置后，点击字段设置界面正确显示已配置的关联关系。
  - 在选择关联列时，仅显示与当前字段类型相同的目标列选项。
  - 在选择关联列时，仅显示与当前字段名称相同的目标列选项，确保字段名称匹配。
  - 在创建双向关联时，确保自动生成的反向关联字段使用与源字段相同的名称。
  - 为关联字段功能添加高亮背景、边框和圆角，明确标示功能范围。
  - 为字典子表功能添加高亮背景、边框和圆角，明确标示功能范围。
  - 在新字段创建和已有字段修改界面使用相同的分区样式，保持一致性。
- 成功标准：
  - 可同时勾选并配置关联字段和字典子表功能。
  - 勾选关联字段功能后不再显示关联类型选择界面。
  - 表头显示清晰的关联表名称信息，以小字形式展示。
  - 用户只需在一个表中创建关联字段，系统自动在目标表中生成对应的反向关联字段，无需手动操作两次。
  - 被关联表的字段名下方显示关联表格名称的小字。
  - 创建关联字段后，点击字段设置能正确显示已设置的关联关系。
  - 系统仅允许相同类型的字段建立关联关系。
  - 系统仅允许相同名称的字段建立关联关系。
  - 创建关联字段时，选择列表中只显示类型和名称都匹配的目标字段。
  - 系统运行稳定，无错误提示。
  - 界面上关联字段功能有明确的视觉区分，用户可以轻易识别。
  - 界面上字典子表功能有明确的视觉区分，用户可以轻易识别。
  - 新字段创建和已有字段修改界面的功能分区保持一致性。
- 成功标准：两种视图均可正常访问和编辑数据；移动端布局简洁，触控友好。

### 行拖拽与顺序持久化
- 功能：在无排序/筛选/搜索条件时，支持通过拖拽调整行顺序；顺序在后端持久化。
- 触发：在表格视图中按住行拖动手柄进行上下拖拽。
- 限制：当开启排序、筛选或搜索时不支持行拖拽（界面提示错误）。
- 流程：拖拽完成 → 前端更新`rows`顺序 → 触发表更新 → 后端通过`row_orders`持久化顺序。
- 成功标准：刷新后顺序保持；新建行在未设置顺序时追加末尾；支持撤回到拖拽前状态。

### 导出
- 功能：将表格数据导出为`xlsx`格式；支持导出选中的行。
- 成功标准：导出文件可在Excel中正常打开与编辑；导出仅包含选中数据（在批量导出场景）。

### 撤销与历史
- 撤销栈：提供“回滚上次操作”按钮，支持连续回滚；每次回滚也会记录快照。
- 历史记录：
  - 下拉菜单显示历史列表（时间使用本地格式化，支持相对时间徽章展示）；
  - 选择历史项弹出确认对话框，确认后回溯到该版本；
  - 支持“保存当前版本并清除历史记录”。
- 成功标准：操作后快照可查询；回溯后刷新数据并提示成功；审计链完整。

## 用户流程
- 新建子表：点击“新增子表”→ 输入名称 → 创建 → 自动记录“新增子表”快照。
- 编辑列：打开“欄位設定”对话 → 编辑名称/类型/选项/多选模式 → 保存 → 快照记录；必要时批量同步行值。
- 新增/编辑/删除行：在网格/卡片视图中对单元格内联编辑、添加或删除；支持行选择与批量操作。
- 行拖拽：当未开启排序/筛选/搜索时，用手柄上下拖拽调整顺序；完成后提示“行顺序已更新”。
- 文件上传与预览：在`file`列点击上传；支持预览与清空；清空仅取消列关联。
- 视图切换：工具栏切换到网格/卡片；移动端默认卡片视图。
- 撤销与历史：点击“回滚上次操作”或在“历史记录”中选择条目并确认回溯。

## 界面设计规范
- 颜色与字体：延续蓝色为主、灰为辅、橙色强调；使用 Inter 字体家族，层级清晰（H1/H2/H3/正文/标签）。
- 动画：适度淡入/过渡，强调数据操作的即时反馈，避免干扰。
- 组件：表格、卡片、对话框、按钮、输入、选择、选项卡、下拉菜单、复选框、图标（加号、下载、撤回、历史、垃圾桶等）。
- 桌面表格布局：
  - 表头：选择列（全选/取消全选）+ 可排序/可拖拽列 + 预留操作列；
  - 行：左侧手柄可拖拽；右侧操作按钮；空状态与筛选空结果提供引导与清除入口。
- 移动布局：卡片列表优先显示前三列，其余以“还有 N 个欄位”提示；顶部提供选择与删除。
- 导航栏（左侧）：标题“孵化之路信息管理系統”、存储状态、版本信息、子表管理、底部反馈入口；移动端提供汉堡按钮与遮罩。

## 技术要求
- 前端
  - DnD：采用`@dnd-kit`实现列/行拖拽；行拖拽受排序/筛选/搜索状态约束。
  - 导出：使用`xlsx`库生成`xlsx`文件。
  - 提示：采用`sonner`；仅保留具体操作成功反馈；切换表格不显示全局提示。
  - 视图与状态：网格/卡片视图切换；移动端自适配（屏宽<768默认卡片视图，隐藏侧栏）。
  - API封装：`/api`为基地址；统一`fetch`封装，错误抛出并记录日志。
- 后端
  - 数据库：SQLite；表结构包含`tables`、`rows`、`row_orders`、`table_history`等。
  - 行顺序：`row_orders(table_id, row_id, position)`；`getTableRows`通过`LEFT JOIN row_orders`并按`position ASC`与`created_at ASC`排序；未设置顺序的行排在末尾。
  - 行顺序API：
    - `GET /api/tables/:tableId/rows/order` → 返回`{ orderIds: string[] }`
    - `PUT /api/tables/:tableId/rows/order` → 请求`{ orderIds: string[] }`
  - 行数据API：`GET/POST/PUT/DELETE /api/tables/:tableId/rows`及批量接口`POST /api/tables/:tableId/rows/batch`（`operation=update|delete|create`）。
  - 文件上传：`POST /api/tables/:tableId/rows/:rowId/files/:columnId`；清空：`DELETE /api/tables/:tableId/rows/:rowId/files/:columnId`；静态访问路径`/api/uploads/...`。
  - 历史API：
    - 列表：`GET /api/tables/:tableId/history`
    - 详情：`GET /api/tables/:tableId/history/:historyId`
    - 新增：`POST /api/tables/:tableId/history`（若未提供`snapshot`，后端自动生成当前快照）
    - 清空：`DELETE /api/tables/:tableId/history`
    - 回溯：`POST /api/tables/:tableId/history/:historyId/revert`
  - 健康检查：`GET /api/health`
- 代理与本地运行
  - 前端开发服务器通过 Vite 代理`/api`到后端（`http://localhost:8000`）。

## 边缘情况处理
- 空表格：显示占位与引导；提供新增入口。
- 无效数据类型：清晰验证消息，防止无效输入。
- 大型数据集：表格支持虚拟滚动（按需优化）。
- 并发与冲突：通过乐观更新与冲突解决；必要时刷新以对齐后端状态。
- 存储与访问：当文件访问端口与前端不同，前端将相对路径转换为完整URL以确保可预览。

## 提示优化（当前状态）
- 目标：减少无关提示，只在实际操作（新增/编辑/删除/拖拽/上传/导出/回溯等）时给出明确反馈。
- 切换表格：不再显示“表格已更新/已加载上次保存数据”等全局提示。

## 成功标准（摘要）
- 行顺序：拖拽后持久化，刷新保持顺序；限制条件明确并有错误提示；支持撤回。
- 历史：每次重要操作自动保存快照；列表/回溯/清空流程可用，确认对话框信息完整。
- 导出：`xlsx`文件生成稳定，能在Excel正常打开；支持导出选中子集。
- 文件：上传与预览稳定；清空列内附件信息不删除磁盘文件；URL在不同端口下可正确访问。
- 响应式：桌面/移动布局与交互一致性良好；移动端默认卡片视图与汉堡菜单生效。
- 导航与版本：反馈入口跳转正常；版本信息以蓝色圆点+文本显示，便于识别与维护。