# 用户手册（v1.1）

## 1) 更新说明
- 版本 v1.1（当前）
  - 行拖拽与顺序持久化：无筛选/排序/搜索时支持拖拽排序；顺序持久化到后端，刷新后保持；支持撤回。
  - 历史与回溯：支持创建快照、查看历史列表与详情、清空历史、回溯到指定版本；回溯需弹窗确认。
  - 撤销能力：提供“回滚上次操作”按钮与全局撤销栈；每次操作记录快照用于审计。
  - 导出增强：支持导出为`xlsx`；支持导出选中数据行。
  - 文件附件：列类型新增`file`；支持上传与预览（图片/视频/音频/PDF/其他），清空列内附件信息不删除磁盘文件。
  - 响应式与移动优化：移动端默认卡片视图；支持汉堡菜单与遮罩；桌面为网格视图。
  - 提示优化：移除切换表格时的全局提示，仅保留操作成功反馈。
  - 导航与版本信息：左侧导航底部新增“反馈建议入口”外链；显示版本信息`v1.1`（蓝点+文本）。
- 版本 v1.0（基线）
  - 子表管理、列配置（文本/数字/日期/布尔/选择）、基本行CRUD、视图切换（网格/卡片）、xlsx导出等基础能力。

## 2) 产品介绍
- 核心功能：
  - 子表管理（新建/重命名/删除）、列配置（类型与选项）、数据编辑（行/单元格）、视图切换（网格/卡片）。
  - 拖拽排序（行/列）、列宽调整、批量操作（删除/更新）、导出到`xlsx`、文件上传与预览、历史与撤回。
- 设计理念：
  - 专业：清晰的数据密集型布局，减少干扰与不必要提示。
  - 直观：操作即所得，避免复杂配置与学习成本。
  - 高效：快捷操作与乐观更新，支持批量与撤回。
- 适用场景：
  - 团队数据收集与轻量表格管理、项目进度追踪、素材与附件归档、简单数据看板。

## 3) 操作总览
- 界面元素说明：
  - 左侧导航：项目标题、存储状态（绿点+“本地存儲 SQLite”）、版本信息（蓝点+`v1.1`）、子表列表、底部“反馈建议入口”。
  - 顶部工具栏：视图切换（网格/卡片）、导出、历史下拉与回溯、撤销按钮、筛选/排序/搜索入口（如有）。
  - 主工作区：网格视图（表头可拖拽列顺序与调整宽度；行左侧手柄用于拖拽）、卡片视图（移动端默认）。
- 快速开始（本地运行）：
  - 启动后端：在`server`目录执行`npm run dev`（默认端口`8000`）。
  - 启动前端：在项目根执行`npm run dev`（Vite默认端口，如`5173`）；前端通过代理访问`/api`（指向`http://localhost:8000`）。
  - 访问地址：浏览器打开前端地址（终端输出的`Local:`链接）。

## 4) 详细操作指引
- 新建子表：
  - 点击“新增子表”→ 输入名称 → 保存 → 子表显示在侧栏；自动记录历史快照。
- 列管理：
  - 新增/删除列：在表头或配置入口添加/删除列。
  - 类型与选项：支持`text`、`number`、`date`、`boolean`、`select`（单选/多选）、`file`、`url`、`email`、`phone`；选择类型可编辑选项与启用多选。
  - 列顺序与宽度：表头支持拖拽调整顺序；列宽最小`120px`，默认`200px`。
- 行数据：
  - 新增：点击“新增行”或在空行处编辑；
  - 编辑：单元格内联编辑，按`Enter/Tab`保存并移动；
  - 删除：选择行后批量删除或单行删除；支持撤回。
- 行拖拽排序：
  - 拖拽条件：未开启排序、筛选或搜索时可拖拽；否则提示不支持。
  - 操作：拖动左侧手柄上下调整顺序 → 自动持久化到后端 → 刷新后顺序保持；可撤回到拖拽前状态。
- 批量操作：
  - 选择：行前复选框单选/多选，全选；
  - 批量更新/删除：在批量入口选择操作，保存后更新所有选中行。
- 导出：
  - 导出所有或导出选中：点击“匯出”生成`xlsx`文件；选中后仅导出所选行；在Excel中打开编辑。
- 文件上传与预览：
  - 在`file`列上传附件，支持图片/视频/音频/PDF/其他；点击预览弹窗查看；
  - 清空列内附件信息：仅清除列关联，不删除磁盘文件；便于撤回。
- 历史与回溯：
  - 创建快照：在历史入口保存当前版本；或系统在关键操作后自动记录；
  - 查看与回溯：下拉菜单查看列表与详情；选择条目后弹窗确认回溯；
  - 清空历史：支持一次性清除所有历史记录（谨慎操作）。
- 撤销操作：
  - 使用“回滚上次操作”连续撤回；撤回也记录快照；完成后提示成功。
- 视图切换与移动端：
  - 视图按钮在网格/卡片之间切换；移动端默认使用卡片视图并隐藏侧栏，支持汉堡菜单。

## 5) 重要逻辑说明
- 行顺序持久化：
  - 后端表`row_orders(table_id, row_id, position)`保存顺序；
  - 获取行数据按`position ASC`与`created_at ASC`排序；未设置顺序的行排在末尾。
  - API：`GET /api/tables/:tableId/rows/order`返回`{ orderIds: string[] }`；`PUT /api/tables/:tableId/rows/order`提交`{ orderIds: string[] }`。
- 历史与快照：
  - 快照生成与存储在后端；支持列表查询、详情查看、清空与回溯；
  - API：
    - 列表：`GET /api/tables/:tableId/history`
    - 详情：`GET /api/tables/:tableId/history/:historyId`
    - 新增：`POST /api/tables/:tableId/history`（可不传`snapshot`由后端生成）
    - 清空：`DELETE /api/tables/:tableId/history`
    - 回溯：`POST /api/tables/:tableId/history/:historyId/revert`
- 撤销栈：
  - 前端维护撤销栈；用户点击“回滚上次操作”依次撤回；每次撤回也写入历史，保持审计链。
- 文件处理：
  - 上传文件的静态访问路径为`/api/uploads/...`；清空列的附件信息不会删除磁盘文件，便于恢复。
- API与代理：
  - 基地址`/api`；前端通过 Vite 代理到后端`http://localhost:8000`；健康检查`GET /api/health`。
- 提示与错误处理：
  - 使用轻量提示（操作成功时显示）；切换子表不显示全局“已更新”类提示；错误会在界面或日志中提示。

## 常见问题（FAQ）
- 行拖拽不可用：检查是否开启了排序、筛选或搜索；关闭后重试。
- 后端端口占用（8000）：关闭占用进程或修改后端端口后重启；前端代理需与后端端口一致。
- 文件预览无法打开：确认前端已将相对路径转换为完整URL；检查后端静态路径`/api/uploads/...`可访问。
- 导出文件异常：请使用Excel或兼容软件打开；确认系统区域设置与编码正常。
- 回溯失败或无历史：确认已创建快照或进行过数据操作；历史列表需存在可选条目。

## 故障排除指南
- 检查后端健康：访问`http://localhost:8000/api/health`，返回`ok`或状态信息表示后端可用。
- 校验API连通：从前端打开数据列表，如无法加载，请检查 Vite 代理与后端端口。
- 刷新状态：操作后数据不一致时刷新页面或重新拉取表数据以对齐后端。

## 高级功能说明
- 批量更新：选择多行后批量修改某列或多个列的值，适合选项变更与数据统一化。
- 历史清理：在版本管理中清空历史条目以降低存储；清空前可先保存当前版本。
- 导出选中：通过勾选行后导出，仅生成所选子集的`xlsx`，适合分享与分析。

## 附录
- 术语：
  - 子表：项目中管理的单个数据表。
  - 快照：某一时刻的表结构与数据的完整记录，用于回溯。
  - 代理：前端将`/api`请求转发到后端服务的网络设置。